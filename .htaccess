<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /aset-academy/

    # Security: Block access to sensitive files
    RewriteRule ^(application|system|tests)/ - [F,L]
    RewriteRule ^(.*/)?\.(env|git|gitignore|htaccess|htpasswd)$ - [F,L]
    RewriteRule ^(composer\.json|composer\.lock|package\.json|package-lock\.json|yarn\.lock)$ - [F,L]
    RewriteRule ^(config|database|logs)/ - [F,L]
    RewriteRule \.(bak|backup|old|orig|tmp|temp|swp|swo)$ - [F,L]
    RewriteRule ^(README|CHANGELOG|LICENSE|VERSION|INSTALL)$ - [F,L]

    # Security: Block access to backup and temporary files
    RewriteRule ^.*\.(bak|backup|old|orig|tmp|temp|swp|swo|inc|log)$ - [F,L]
    RewriteRule ^.*~$ - [F,L]

    # Security: Block access to common attack vectors
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*iframe.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*object.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*embed.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*applet.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*meta.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*link.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*form.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*input.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*select.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*textarea.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*button.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*style.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} base64_encode.*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} base64_decode.*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} union.*select.*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} (eval|system|exec|shell_exec|passthru|popen|proc_open).*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} (javascript|vbscript|onload|onerror|onclick|onmouseover|onmouseout).* [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C)(.*)(>|%3E) [NC]
    RewriteRule .* - [F,L]

    # Security: Block common attack patterns
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS)$ [NC]
    RewriteRule .* - [F,L]

    # Security: Block access from bad user agents
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|BBBike|wget|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner|python-requests|Go-http-client|java/|okhttp|scrapy|crawler) [NC]
    RewriteRule .* - [F,L]

    # Security: Rate limiting for admin area
    RewriteCond %{REQUEST_URI} ^/aset-academy/admin [NC]
    RewriteCond %{TIME_SEC} ^(0[0-9]|1[0-9]|2[0-3])$
    RewriteCond %{TIME_MIN} ^[0-5][0-9]$
    RewriteRule .* - [F,L]

    # Removes index.php from URLs
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php/$1 [L]
</IfModule>

# Prevent directory listing
Options -Indexes

# Security Headers
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Feature Policy / Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), magnetometer=(), gyroscope=(), accelerometer=(), payment=()"

    # Content Security Policy (basic)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://code.jquery.com https://unpkg.com https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://ip-api.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"

    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Hide server information
    Header always unset X-Powered-By
    Header always unset Server

    # Prevent caching of sensitive content
    <FilesMatch "\.(php|html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

    # CORS headers (restrictive)
    Header always set Access-Control-Allow-Origin "https://localhost"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    Header always set Access-Control-Allow-Credentials "true"
</IfModule>

# PHP Security Settings
<IfModule mod_php.c>
    # Disable dangerous PHP functions
    php_flag register_globals off
    php_flag allow_url_fopen off
    php_flag allow_url_include off
    php_flag display_errors off
    php_flag log_errors on
    php_value error_reporting E_ALL & ~E_NOTICE
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 1
    php_value session.use_only_cookies 1
    php_value session.use_trans_sid 0
</IfModule>

# File Protection
<Files "composer.json">
    Order allow,deny
    Deny from all
</Files>

<Files "composer.lock">
    Order allow,deny
    Deny from all
</Files>

<Files "package.json">
    Order allow,deny
    Deny from all
</Files>

<Files "yarn.lock">
    Order allow,deny
    Deny from all
</Files>

<FilesMatch "\.(env|git|gitignore|htaccess|htpasswd)$">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "\.(bak|backup|old|orig|tmp|temp|swp|swo|inc|log)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Directory Protection
<Directory "application">
    Order allow,deny
    Deny from all
    <FilesMatch "\.(php|html|css|js)$">
        Allow from all
    </FilesMatch>
</Directory>

<Directory "system">
    Order allow,deny
    Deny from all
</Directory>

<Directory "assets">
    Order allow,deny
    Allow from all
    <FilesMatch "\.(php)$">
        Deny from all
    </FilesMatch>
</Directory>

<Directory "uploads">
    Order allow,deny
    Allow from all
    <FilesMatch "\.(php|exe|bat|cmd|com)$">
        Deny from all
    </FilesMatch>
</Directory>

# Block access to sensitive directories
RedirectMatch 404 ^/aset-academy/(application|system|tests)/.*$
RedirectMatch 404 ^/aset-academy/\.git.*$

# Rate limiting
<IfModule mod_evasive24.c>
    DOSHashTableSize 100
    DOSPageCount 5
    DOSPageInterval 1
    DOSSiteCount 50
    DOSSiteInterval 1
    DOSBlockingPeriod 600
</IfModule>
